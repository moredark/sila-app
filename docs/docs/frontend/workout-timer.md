---
sidebar_position: 3
---

# Таймер тренировки

Компонент `useWorkoutTimer` предоставляет надежный таймер для отслеживания времени тренировки, который работает даже когда PWA приложение свернуто на мобильных устройствах.

## Возможности

- Точное отслеживание времени даже при сворачивании приложения
- Сохранение состояния и времени между сессиями
- Автоматическое восстановление после перезагрузки приложения
- Интеграция с PWA-приложениями
- Поддержка паузы/возобновления
- Предотвращение утечек памяти

## API

Хук `useWorkoutTimer` возвращает объект со следующими свойствами и методами:

```typescript
interface UseWorkoutTimerReturn {
  time: number; // Текущее время в секундах
  isRunning: boolean; // Флаг запущенного таймера
  isPaused: boolean; // Флаг приостановленного таймера
  startTimer: () => void; // Запуск таймера
  pauseTimer: () => void; // Приостановка таймера
  resetTimer: () => void; // Сброс таймера
  togglePause: () => void; // Переключение пауза/запуск
  handleSetAdded: () => void; // Обработка добавления нового подхода
}
```

## Пример использования

```tsx
import { useWorkoutTimer } from "@/widgets/Timer/useWorkoutTimer";
import { formatTime } from "@/shared/utils/formatTime";

export function WorkoutTimerExample() {
  const { time, isRunning, isPaused, startTimer, pauseTimer, resetTimer } =
    useWorkoutTimer();

  return (
    <div className="flex flex-col gap-4">
      <div className="text-3xl font-bold">{formatTime(time)}</div>

      <div className="flex gap-2">
        {!isRunning && !isPaused && (
          <button onClick={startTimer}>Начать</button>
        )}

        {isRunning && <button onClick={pauseTimer}>Пауза</button>}

        {isPaused && <button onClick={startTimer}>Продолжить</button>}

        <button onClick={resetTimer}>Сбросить</button>
      </div>
    </div>
  );
}
```

## Принцип работы

Таймер основан на использовании абсолютных временных меток, что позволяет корректно вычислять прошедшее время даже когда приложение свернуто.

### Ключевые особенности реализации:

1. Сохранение времени начала и прошедшего времени в LocalStorage
2. Использование временных меток для расчета прошедшего времени
3. Обновление UI через интервалы для отображения времени
4. Обработка событий жизненного цикла PWA (visibilitychange, focus, pageshow)

### Обработка сворачивания приложения

Когда приложение сворачивается, таймер сохраняет текущее время и временную метку начала. При возвращении в приложение таймер вычисляет прошедшее время, добавляет его к сохраненному значению и обновляет временную метку начала.

## Предотвращение утечек памяти

Таймер спроектирован с учетом предотвращения утечек памяти:

1. **Очистка интервалов**: Все созданные интервалы (`setInterval`) гарантированно очищаются в функциях очистки эффектов:

   ```typescript
   useEffect(() => {
     // Установка интервала
     intervalRef.current = setInterval(() => {
       /* ... */
     }, 1000);

     // Функция очистки, вызывается при размонтировании компонента
     return () => {
       if (intervalRef.current) {
         clearInterval(intervalRef.current);
         intervalRef.current = null;
       }
     };
   }, [dependencies]);
   ```

2. **Удаление обработчиков событий**: Все добавленные обработчики событий корректно удаляются:

   ```typescript
   useEffect(() => {
     window.addEventListener("visibilitychange", handleVisibilityChange);
     window.addEventListener("focus", handleVisibilityChange);

     return () => {
       window.removeEventListener("visibilitychange", handleVisibilityChange);
       window.removeEventListener("focus", handleVisibilityChange);
     };
   }, [dependencies]);
   ```

3. **Использование useRef для хранения ссылок**: Для хранения идентификаторов интервалов используется `useRef`, что позволяет избежать проблем с замыканиями и обеспечивает доступ к актуальным значениям.

4. **Безопасная работа с localStorage**: Все операции с localStorage обернуты в блоки try-catch, что предотвращает сбои при ограничениях доступа.

5. **Проверка состояния монтирования**: Хук использует ref для отслеживания состояния монтирования компонента, предотвращая обновление состояния в размонтированных компонентах.

## Интеграция с PWA

Таймер специально оптимизирован для работы в PWA-приложениях на мобильных устройствах:

1. Использует localStorage для сохранения состояния
2. Обрабатывает события жизненного цикла PWA
3. Корректно восстанавливается после сворачивания приложения
4. Работает в различных режимах энергосбережения

## Устранение неполадок

Если таймер не считает время или работает некорректно:

1. Убедитесь, что у приложения есть доступ к localStorage
2. Проверьте, что на странице добавлена директива 'use client'
3. Проверьте, что в компоненте корректно используются методы хука
4. При проблемах с отображением времени проверьте, что time корректно форматируется
5. Если возникают проблемы с производительностью, убедитесь, что компонент корректно размонтируется, чтобы избежать утечек памяти
