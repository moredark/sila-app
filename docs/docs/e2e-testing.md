---
sidebar_position: 5
---

# E2E тестирование

В проекте Sila App настроено автоматизированное end-to-end тестирование с использованием Playwright.

## Основные особенности

- **Мобильное тестирование**: Тесты эмулируют мобильные устройства (Pixel 7, iPhone 14)
- **Авторизация**: Автоматическая авторизация для тестов через хранение состояния
- **Расширенный класс EnhancedPage**: Типобезопасная работа с Playwright и обработка нестабильных UI элементов
- **CI/CD интеграция**: Автоматический запуск тестов в GitHub Actions

## Настройка окружения

```bash
# Переход в директорию e2e тестов
cd e2e-tests

# Установка зависимостей
pnpm install

# Установка браузеров Playwright
pnpm run install
```

## Настройка переменных окружения

Создайте файл `.env` в директории e2e-tests со следующими переменными:

```
TEST_EMAIL=your_test_email
TEST_PASSWORD=your_test_password
BASE_URL=https://sila-danila.ru
```

## Структура тестов

- **fixtures/base.fixture.ts** - расширенные фикстуры и класс EnhancedPage
- **tests/auth-setup.spec.ts** - специальный тест для настройки авторизации
- **tests/** - основные тесты (с авторизацией по умолчанию)
- **tests/public/** - тесты, не требующие авторизации (запускаются отдельно)

## Архитектура тестов

### Фикстуры и EnhancedPage

В проекте реализована система типобезопасных фикстур с использованием класса `EnhancedPage`, который:

- Расширяет стандартный `Page` Playwright, добавляя полезные методы
- Обеспечивает типобезопасность без использования `any`
- Улучшает стабильность тестов через механизмы повторных попыток
- Предоставляет решения для проблемных мест UI (комбобоксы, нестабильные элементы)

Основные расширенные методы:

| Метод                      | Описание                                                           |
| -------------------------- | ------------------------------------------------------------------ |
| `safeGoto(url)`            | Безопасная навигация с ожиданием загрузки страницы                 |
| `retryAction(fn, options)` | Выполняет действие с автоматическими повторными попытками          |
| `openCombobox(selector)`   | Надежно открывает комбобокс с автоматическими повторными попытками |

### Авторизация

Глобальная настройка авторизации в `global-setup.ts`:

- Автоматически применяется ко всем тестам (кроме тестов в папке `public/`)
- Состояние авторизации сохраняется в файле `playwright/.auth/user.json`
- Имеет TTL 24 часа для оптимизации повторных запусков
- Поддерживает механизм повторных попыток авторизации

## Запуск тестов

```bash
# Запуск всех тестов
pnpm test

# Запуск тестов с UI интерфейсом
pnpm test:ui

# Запуск тестов в режиме с видимым браузером
pnpm test:headed

# Запуск тестов в режиме отладки
pnpm test:debug

# Показать отчет о тестировании
pnpm report
```

## Запуск в CI/CD

Тесты запускаются в CI со следующими особенностями:

1. URL для тестирования по умолчанию: https://sila-danila.ru
2. Для авторизации используются секреты из GitHub Secrets (TEST_EMAIL, TEST_PASSWORD)
3. В CI запускаются только тесты на Chromium для обеспечения стабильности

## Конфигурация

Конфигурация Playwright находится в `playwright.config.ts`. В текущей настройке:

- Все тесты запускаются с **мобильным разрешением**
- Поддерживаются два мобильных устройства:
  - Pixel 7 (для Chromium)
  - iPhone 14 (для WebKit) - **только при локальном запуске**
- В CI среде запускаются только тесты Chromium (Pixel 7) для обеспечения совместимости
- **Авторизация включена по умолчанию** для всех тестов (кроме папки `public/`)

## Примеры тестов

### Тесты с авторизацией (основной тип)

```typescript
import { authTest, expect } from "../fixtures/base.fixture";

authTest.describe("Название тестового набора", () => {
  authTest("Название теста", async ({ enhancedPage, page }) => {
    // `enhancedPage` - расширенная типобезопасная страница с доп. методами

    // Безопасный переход на страницу
    await enhancedPage.safeGoto("/some-path");

    // Нестабильное действие с повторными попытками
    await enhancedPage.retryAction(
      async () => {
        await page.getByRole("button", { name: "Кнопка" }).click();
      },
      { maxRetries: 3, label: "нажатие кнопки" }
    );

    // Проверка
    await expect(page.getByText("Результат")).toBeVisible();
  });
});
```

### Тесты без авторизации

```typescript
import { test, expect } from "@playwright/test";

test("Название теста", async ({ page }) => {
  await page.goto("/auth/login");
  // ...
});
```
